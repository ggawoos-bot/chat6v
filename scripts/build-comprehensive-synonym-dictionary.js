/**
 * í¬ê´„ì  ë™ì˜ì–´ ì‚¬ì „ êµ¬ì¶• ì‹œìŠ¤í…œ
 * PDFì—ì„œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ê³  AI ê¸°ë°˜ ë™ì˜ì–´ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ì „ êµ¬ì¶•
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { createRequire } from 'module';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, query, getDocs } from 'firebase/firestore';

const require = createRequire(import.meta.url);
const { GoogleGenerativeAI } = require('@google/generative-ai');
const pdfParse = require('pdf-parse');

// Firebase ì´ˆê¸°í™”
const firebaseConfig = {
  apiKey: process.env.FIREBASE_API_KEY || "AIzaSyA0zyaTI--MHXoNPYlTf95S6iJu67XdRic",
  authDomain: process.env.FIREBASE_AUTH_DOMAIN || "chat6-4b97d.firebaseapp.com",
  projectId: process.env.FIREBASE_PROJECT_ID || "chat6-4b97d",
  storageBucket: process.env.FIREBASE_STORAGE_BUCKET || "chat6-4b97d.firebasestorage.app",
  messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID || "437591723431",
  appId: process.env.FIREBASE_APP_ID || "1:437591723431:web:9f228e7d46f33f9d49fa82"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

class AdvancedKeywordExtractor {
  constructor() {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      throw new Error('GEMINI_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    this.ai = new GoogleGenerativeAI(apiKey);
    this.extractedKeywords = new Map();
    this.synonymMappings = new Map();
  }

  /**
   * PDFì—ì„œ ì˜ë¯¸ìˆëŠ” í‚¤ì›Œë“œ ì¶”ì¶œ
   */
  async extractMeaningfulKeywords(pdfText) {
    const keywords = new Set();
    
    // 1. í˜•íƒœì†Œ ë¶„ì„ì„ í†µí•œ ëª…ì‚¬ ì¶”ì¶œ
    const nouns = this.extractNouns(pdfText);
    nouns.forEach(noun => keywords.add(noun));
    
    // 2. ì „ë¬¸ìš©ì–´ ì¶”ì¶œ (ë²•ë ¹, ì‹œì„¤ëª… ë“±)
    const technicalTerms = this.extractTechnicalTerms(pdfText);
    technicalTerms.forEach(term => keywords.add(term));
    
    // 3. ë³µí•©ì–´ ì¶”ì¶œ (2-4ê¸€ì ì¡°í•©)
    const compounds = this.extractCompounds(pdfText);
    compounds.forEach(compound => keywords.add(compound));
    
    // 4. AI ê¸°ë°˜ ì˜ë¯¸ìˆëŠ” í‚¤ì›Œë“œ ì¶”ì¶œ
    const aiKeywords = await this.extractKeywordsWithAI(pdfText);
    aiKeywords.forEach(keyword => keywords.add(keyword));
    
    return Array.from(keywords);
  }

  /**
   * í˜•íƒœì†Œ ë¶„ì„ì„ í†µí•œ ëª…ì‚¬ ì¶”ì¶œ
   */
  extractNouns(text) {
    const nouns = new Set();
    
    // í•œê¸€ ëª…ì‚¬ íŒ¨í„´ (2-10ê¸€ì)
    const koreanNounPattern = /[ê°€-í£]{2,10}/g;
    const matches = text.match(koreanNounPattern) || [];
    
    matches.forEach(match => {
      // ë¶ˆìš©ì–´ í•„í„°ë§
      if (!this.isStopWord(match) && this.isMeaningfulWord(match)) {
        nouns.add(match);
      }
    });
    
    return Array.from(nouns);
  }

  /**
   * ì „ë¬¸ìš©ì–´ ì¶”ì¶œ
   */
  extractTechnicalTerms(text) {
    const terms = new Set();
    
    // ë²•ë ¹ ê´€ë ¨ íŒ¨í„´
    const legalPatterns = [
      /[ê°€-í£]+ë²•(ë¥ )?/g,
      /[ê°€-í£]+ì‹œí–‰ë ¹/g,
      /[ê°€-í£]+ì‹œí–‰ê·œì¹™/g,
      /[ê°€-í£]+ì§€ì¹¨/g,
      /[ê°€-í£]+ê°€ì´ë“œë¼ì¸/g,
      /[ê°€-í£]+ë§¤ë‰´ì–¼/g
    ];
    
    // ì‹œì„¤ ê´€ë ¨ íŒ¨í„´
    const facilityPatterns = [
      /[ê°€-í£]+ì‹œì„¤/g,
      /[ê°€-í£]+ì„¼í„°/g,
      /[ê°€-í£]+ê´€/g,
      /[ê°€-í£]+ì¥/g,
      /[ê°€-í£]+ì›/g,
      /[ê°€-í£]+ì†Œ/g
    ];
    
    [...legalPatterns, ...facilityPatterns].forEach(pattern => {
      const matches = text.match(pattern) || [];
      matches.forEach(match => terms.add(match));
    });
    
    return Array.from(terms);
  }

  /**
   * ë³µí•©ì–´ ì¶”ì¶œ
   */
  extractCompounds(text) {
    const compounds = new Set();
    
    // 2-4ê¸€ì ì¡°í•© ì¶”ì¶œ
    const compoundPattern = /[ê°€-í£]{2,4}/g;
    const matches = text.match(compoundPattern) || [];
    
    matches.forEach(match => {
      if (this.isCompoundWord(match)) {
        compounds.add(match);
      }
    });
    
    return Array.from(compounds);
  }

  /**
   * AI ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ
   */
  async extractKeywordsWithAI(text) {
    try {
      const prompt = `
ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ ì˜ë¯¸ìˆëŠ” í‚¤ì›Œë“œë“¤ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”:

${text.substring(0, 2000)} // í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ

ë‹¤ìŒ ê¸°ì¤€ìœ¼ë¡œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”:
1. ë²•ë ¹, ê·œì •, ì§€ì¹¨ ê´€ë ¨ ìš©ì–´
2. ì‹œì„¤, ì¥ì†Œ, ê¸°ê´€ ê´€ë ¨ ìš©ì–´  
3. í–‰ì •, ì ˆì°¨, ê´€ë¦¬ ê´€ë ¨ ìš©ì–´
4. ê±´ê°•, ê¸ˆì—°, ë³´ê±´ ê´€ë ¨ ìš©ì–´
5. êµìœ¡, ë³´ìœ¡ ê´€ë ¨ ìš©ì–´
6. ê¸°íƒ€ ì „ë¬¸ìš©ì–´

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", ...]
}
`;

      const model = this.ai.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      const parsed = JSON.parse(text);
      return parsed.keywords || [];
    } catch (error) {
      console.error('AI í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨:', error);
      return [];
    }
  }

  /**
   * AI ê¸°ë°˜ ë™ì˜ì–´ ìƒì„±
   */
  async generateSynonymsWithAI(keyword) {
    try {
      const prompt = `
"${keyword}"ì˜ ë™ì˜ì–´ì™€ ìœ ì‚¬ì–´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ ê¸°ì¤€ìœ¼ë¡œ ë™ì˜ì–´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”:
1. ì™„ì „í•œ ë™ì˜ì–´ (ê°™ì€ ì˜ë¯¸)
2. ìœ ì‚¬í•œ ì˜ë¯¸ì˜ ë‹¨ì–´
3. ê´€ë ¨ëœ ì „ë¬¸ìš©ì–´
4. ì¤„ì„ë§ì´ë‚˜ ì•½ì–´
5. ë‹¤ë¥¸ í‘œí˜„ ë°©ì‹

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "synonyms": ["ë™ì˜ì–´1", "ë™ì˜ì–´2", "ë™ì˜ì–´3", ...]
}
`;

      const model = this.ai.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      const parsed = JSON.parse(text);
      return parsed.synonyms || [];
    } catch (error) {
      console.error(`ë™ì˜ì–´ ìƒì„± ì‹¤íŒ¨ (${keyword}):`, error);
      return [];
    }
  }

  /**
   * ë¶ˆìš©ì–´ ì²´í¬
   */
  isStopWord(word) {
    const stopWords = [
      'ê·¸ê²ƒ', 'ì´ê²ƒ', 'ì €ê²ƒ', 'ì–´ë–¤', 'ë¬´ì—‡', 'ì–¸ì œ', 'ì–´ë””', 'ì™œ', 'ì–´ë–»ê²Œ',
      'ê·¸ë¦¬ê³ ', 'ë˜í•œ', 'ë˜ëŠ”', 'ê·¸ëŸ¬ë‚˜', 'í•˜ì§€ë§Œ', 'ë”°ë¼ì„œ', 'ê·¸ëŸ¬ë¯€ë¡œ',
      'ìœ„ì˜', 'ì•„ë˜ì˜', 'ì•ì˜', 'ë’¤ì˜', 'ì¢Œì¸¡', 'ìš°ì¸¡', 'ì¤‘ì•™', 'ì–‘ìª½',
      'ì´ìƒ', 'ì´í•˜', 'ë¯¸ë§Œ', 'ì´ˆê³¼', 'ì´ë‚´', 'ì´ì™¸', 'ì´ìƒ', 'ì´í•˜',
      'ì œ1', 'ì œ2', 'ì œ3', 'ì œ4', 'ì œ5', 'ì œ6', 'ì œ7', 'ì œ8', 'ì œ9', 'ì œ10',
      'ì²«ì§¸', 'ë‘˜ì§¸', 'ì…‹ì§¸', 'ë„·ì§¸', 'ë‹¤ì„¯ì§¸', 'ì—¬ì„¯ì§¸', 'ì¼ê³±ì§¸', 'ì—¬ëŸì§¸', 'ì•„í™‰ì§¸', 'ì—´ì§¸'
    ];
    return stopWords.includes(word);
  }

  /**
   * ì˜ë¯¸ìˆëŠ” ë‹¨ì–´ ì²´í¬
   */
  isMeaningfulWord(word) {
    // 2ê¸€ì ì´ìƒ, ìˆ«ìë‚˜ íŠ¹ìˆ˜ë¬¸ì ì œì™¸
    return word.length >= 2 && /^[ê°€-í£]+$/.test(word);
  }

  /**
   * ë³µí•©ì–´ ì²´í¬
   */
  isCompoundWord(word) {
    // ì˜ë¯¸ìˆëŠ” ë³µí•©ì–´ íŒ¨í„´
    const compoundPatterns = [
      /^[ê°€-í£]+ì‹œì„¤$/,
      /^[ê°€-í£]+ê´€ë¦¬$/,
      /^[ê°€-í£]+ì§€ì›$/,
      /^[ê°€-í£]+ì„œë¹„ìŠ¤$/,
      /^[ê°€-í£]+ì‹œìŠ¤í…œ$/,
      /^[ê°€-í£]+í”„ë¡œê·¸ë¨$/,
      /^[ê°€-í£]+ì •ì±…$/,
      /^[ê°€-í£]+ë°©ì•ˆ$/,
      /^[ê°€-í£]+ì ˆì°¨$/,
      /^[ê°€-í£]+ê¸°ì¤€$/,
      /^[ê°€-í£]+ê·œì •$/,
      /^[ê°€-í£]+ì§€ì¹¨$/,
      /^[ê°€-í£]+ê°€ì´ë“œ$/,
      /^[ê°€-í£]+ë§¤ë‰´ì–¼$/,
      /^[ê°€-í£]+ì•ˆë‚´$/,
      /^[ê°€-í£]+êµìœ¡$/,
      /^[ê°€-í£]+í›ˆë ¨$/,
      /^[ê°€-í£]+ì—°ìˆ˜$/,
      /^[ê°€-í£]+í•™ìŠµ$/,
      /^[ê°€-í£]+ì§€ë„$/,
      /^[ê°€-í£]+ê³„ëª½$/,
      /^[ê°€-í£]+í™ë³´$/,
      /^[ê°€-í£]+ê´‘ê³ $/,
      /^[ê°€-í£]+ì„ ì „$/,
      /^[ê°€-í£]+ìº í˜ì¸$/,
      /^[ê°€-í£]+ì•ˆë‚´$/,
      /^[ê°€-í£]+ê³µì§€$/,
      /^[ê°€-í£]+ìƒë‹´$/,
      /^[ê°€-í£]+ë¬¸ì˜$/,
      /^[ê°€-í£]+ìë¬¸$/,
      /^[ê°€-í£]+ì•ˆë‚´$/,
      /^[ê°€-í£]+ì»¨ì„¤íŒ…$/,
      /^[ê°€-í£]+ë¯¼ì›$/,
      /^[ê°€-í£]+ë¶ˆë§Œ$/,
      /^[ê°€-í£]+ê³ ì¶©$/,
      /^[ê°€-í£]+ê±´ì˜$/,
      /^[ê°€-í£]+ì œì•ˆ$/,
      /^[ê°€-í£]+ì¡°ì‚¬$/,
      /^[ê°€-í£]+ì—°êµ¬$/,
      /^[ê°€-í£]+íƒì‚¬$/,
      /^[ê°€-í£]+ê²€í† $/,
      /^[ê°€-í£]+ë¶„ì„$/,
      /^[ê°€-í£]+ì ê²€$/,
      /^[ê°€-í£]+í™•ì¸$/,
      /^[ê°€-í£]+ê²€ì‚¬$/,
      /^[ê°€-í£]+ê°ì‚¬$/,
      /^[ê°€-í£]+ì§„ë‹¨$/,
      /^[ê°€-í£]+ì•ˆì „ì ê²€$/,
      /^[ê°€-í£]+ì •ê¸°ì ê²€$/,
      /^[ê°€-í£]+ì•ˆì „$/,
      /^[ê°€-í£]+ë³´í˜¸$/,
      /^[ê°€-í£]+ì˜ˆë°©$/,
      /^[ê°€-í£]+ìœ„í—˜ë°©ì§€$/,
      /^[ê°€-í£]+ì•ˆì „ê´€ë¦¬$/,
      /^[ê°€-í£]+ì•ˆì „ìˆ˜ì¹™$/,
      /^[ê°€-í£]+í™˜ê²½$/,
      /^[ê°€-í£]+ìì—°$/,
      /^[ê°€-í£]+ìƒíƒœ$/,
      /^[ê°€-í£]+ì˜¤ì—¼$/,
      /^[ê°€-í£]+ë³´í˜¸$/,
      /^[ê°€-í£]+í™˜ê²½ë³´í˜¸$/,
      /^[ê°€-í£]+í™˜ê²½ì˜¤ì—¼$/,
      /^[ê°€-í£]+ê±´ê°•$/,
      /^[ê°€-í£]+ë³´ê±´$/,
      /^[ê°€-í£]+ìœ„ìƒ$/,
      /^[ê°€-í£]+ì§ˆë³‘$/,
      /^[ê°€-í£]+ì˜ˆë°©$/,
      /^[ê°€-í£]+ê±´ê°•ì¦ì§„$/,
      /^[ê°€-í£]+ê±´ê°•ê´€ë¦¬$/,
      /^[ê°€-í£]+ë³µì§€$/,
      /^[ê°€-í£]+ì‚¬íšŒë³µì§€$/,
      /^[ê°€-í£]+ìƒí™œë³´ì¥$/,
      /^[ê°€-í£]+ì§€ì›$/,
      /^[ê°€-í£]+í˜œíƒ$/,
      /^[ê°€-í£]+ë³µì§€ì„œë¹„ìŠ¤$/,
      /^[ê°€-í£]+ì¸ê¶Œ$/,
      /^[ê°€-í£]+ê¸°ë³¸ê¶Œ$/,
      /^[ê°€-í£]+ììœ $/,
      /^[ê°€-í£]+í‰ë“±$/,
      /^[ê°€-í£]+ì¡´ì—„$/,
      /^[ê°€-í£]+ì¸ê¶Œë³´í˜¸$/,
      /^[ê°€-í£]+ì •ë³´$/,
      /^[ê°€-í£]+ìë£Œ$/,
      /^[ê°€-í£]+ë°ì´í„°$/,
      /^[ê°€-í£]+ì§€ì‹$/,
      /^[ê°€-í£]+ì•ˆë‚´$/,
      /^[ê°€-í£]+ì •ë³´ì œê³µ$/,
      /^[ê°€-í£]+ê¸°ìˆ $/,
      /^[ê°€-í£]+ê³¼í•™$/,
      /^[ê°€-í£]+ê°œë°œ$/,
      /^[ê°€-í£]+í˜ì‹ $/,
      /^[ê°€-í£]+ì—°êµ¬$/,
      /^[ê°€-í£]+ê¸°ìˆ ê°œë°œ$/,
      /^[ê°€-í£]+ê²½ì œ$/,
      /^[ê°€-í£]+ì‚°ì—…$/,
      /^[ê°€-í£]+ì‹œì¥$/,
      /^[ê°€-í£]+íˆ¬ì$/,
      /^[ê°€-í£]+ì„±ì¥$/,
      /^[ê°€-í£]+ê²½ì œë°œì „$/,
      /^[ê°€-í£]+ì‚¬íšŒ$/,
      /^[ê°€-í£]+ê³µë™ì²´$/,
      /^[ê°€-í£]+ë¬¸í™”$/,
      /^[ê°€-í£]+ì‹œë¯¼$/,
      /^[ê°€-í£]+ì§€ì—­ì‚¬íšŒ$/,
      /^[ê°€-í£]+ì‚¬íšŒë¬¸ì œ$/,
      /^[ê°€-í£]+êµ­ê°€$/,
      /^[ê°€-í£]+ì •ë¶€$/,
      /^[ê°€-í£]+ì •ì±…$/,
      /^[ê°€-í£]+ë²•ë¥ $/,
      /^[ê°€-í£]+í–‰ì •$/,
      /^[ê°€-í£]+êµ­ê°€ê¸°ê´€$/,
      /^[ê°€-í£]+ì§€ì—­$/,
      /^[ê°€-í£]+ì§€ë°©$/,
      /^[ê°€-í£]+ì‹œë„$/,
      /^[ê°€-í£]+ì‹œêµ°êµ¬$/,
      /^[ê°€-í£]+ìë©´ë™$/,
      /^[ê°€-í£]+ì§€ì—­ì‚¬íšŒ$/,
      /^[ê°€-í£]+êµ­ì œ$/,
      /^[ê°€-í£]+ì„¸ê³„$/,
      /^[ê°€-í£]+ê¸€ë¡œë²Œ$/,
      /^[ê°€-í£]+í•´ì™¸$/,
      /^[ê°€-í£]+êµ­ì œí˜‘ë ¥$/,
      /^[ê°€-í£]+êµ­ì œê´€ê³„$/,
      /^[ê°€-í£]+ë¯¸ë˜$/,
      /^[ê°€-í£]+ì „ë§$/,
      /^[ê°€-í£]+ì˜ˆì¸¡$/,
      /^[ê°€-í£]+ë¹„ì „$/,
      /^[ê°€-í£]+ì „ëµ$/,
      /^[ê°€-í£]+ë¯¸ë˜ì‚¬íšŒ$/,
      /^[ê°€-í£]+í˜ì‹ $/,
      /^[ê°€-í£]+ì°½ì˜$/,
      /^[ê°€-í£]+ê°œì„ $/,
      /^[ê°€-í£]+ë³€í™”$/,
      /^[ê°€-í£]+ë°œì „$/,
      /^[ê°€-í£]+ê¸°ìˆ í˜ì‹ $/,
      /^[ê°€-í£]+í˜‘ë ¥$/,
      /^[ê°€-í£]+ê³µë™$/,
      /^[ê°€-í£]+ì—°ëŒ€$/,
      /^[ê°€-í£]+íŒŒíŠ¸ë„ˆì‹­$/,
      /^[ê°€-í£]+í˜‘ì—…$/,
      /^[ê°€-í£]+í˜‘ë ¥ê´€ê³„$/,
      /^[ê°€-í£]+ì†Œí†µ$/,
      /^[ê°€-í£]+ëŒ€í™”$/,
      /^[ê°€-í£]+ì˜ì‚¬ì†Œí†µ$/,
      /^[ê°€-í£]+ê³µê°$/,
      /^[ê°€-í£]+ê²½ì²­$/,
      /^[ê°€-í£]+ì†Œí†µì±„ë„$/,
      /^[ê°€-í£]+ì°¸ì—¬$/,
      /^[ê°€-í£]+í™œë™$/,
      /^[ê°€-í£]+ë™ì°¸$/,
      /^[ê°€-í£]+í˜‘ì¡°$/,
      /^[ê°€-í£]+ì˜ê²¬ì œì‹œ$/,
      /^[ê°€-í£]+ì‹œë¯¼ì°¸ì—¬$/,
      /^[ê°€-í£]+íˆ¬ëª…$/,
      /^[ê°€-í£]+ê³µê°œ$/,
      /^[ê°€-í£]+ëª…í™•$/,
      /^[ê°€-í£]+ì •ì§$/,
      /^[ê°€-í£]+ì‹ ë¢°$/,
      /^[ê°€-í£]+íˆ¬ëª…ì„±$/,
      /^[ê°€-í£]+ê³µì •$/,
      /^[ê°€-í£]+ì •ì˜$/,
      /^[ê°€-í£]+í˜•í‰$/,
      /^[ê°€-í£]+ê· ë“±$/,
      /^[ê°€-í£]+ê³µí‰$/,
      /^[ê°€-í£]+ê³µì •ì„±$/,
      /^[ê°€-í£]+ì±…ì„$/,
      /^[ê°€-í£]+ì˜ë¬´$/,
      /^[ê°€-í£]+ì±…ë¬´$/,
      /^[ê°€-í£]+ì±…ì„ê°$/,
      /^[ê°€-í£]+ì±…ì„ì†Œì¬$/,
      /^[ê°€-í£]+ìœ¤ë¦¬$/,
      /^[ê°€-í£]+ë„ë•$/,
      /^[ê°€-í£]+ê°€ì¹˜$/,
      /^[ê°€-í£]+ì›ì¹™$/,
      /^[ê°€-í£]+ì²­ë ´$/,
      /^[ê°€-í£]+ìœ¤ë¦¬ê²½ì˜$/,
      /^[ê°€-í£]+ì¸ì¦$/,
      /^[ê°€-í£]+ê²€ì¦$/,
      /^[ê°€-í£]+í™•ì¸$/,
      /^[ê°€-í£]+ìê²©$/,
      /^[ê°€-í£]+ë©´í—ˆ$/,
      /^[ê°€-í£]+ì¸ì¦ì œë„$/,
      /^[ê°€-í£]+í‘œì¤€$/,
      /^[ê°€-í£]+ê¸°ì¤€$/,
      /^[ê°€-í£]+ê·œê²©$/,
      /^[ê°€-í£]+ëª¨ë²”$/,
      /^[ê°€-í£]+ì§€ì¹¨$/,
      /^[ê°€-í£]+í‘œì¤€í™”$/,
      /^[ê°€-í£]+ë°ì´í„°$/,
      /^[ê°€-í£]+ì •ë³´$/,
      /^[ê°€-í£]+ìë£Œ$/,
      /^[ê°€-í£]+ë¹…ë°ì´í„°$/,
      /^[ê°€-í£]+í†µê³„$/,
      /^[ê°€-í£]+ë°ì´í„°ë¶„ì„$/,
      /^[ê°€-í£]+ì‹œìŠ¤í…œ$/,
      /^[ê°€-í£]+ì²´ê³„$/,
      /^[ê°€-í£]+êµ¬ì¡°$/,
      /^[ê°€-í£]+í”Œë«í¼$/,
      /^[ê°€-í£]+ë„¤íŠ¸ì›Œí¬$/,
      /^[ê°€-í£]+ìš´ì˜ì²´ì œ$/,
      /^[ê°€-í£]+ì„œë¹„ìŠ¤$/,
      /^[ê°€-í£]+ì œê³µ$/,
      /^[ê°€-í£]+ì§€ì›$/,
      /^[ê°€-í£]+í˜œíƒ$/,
      /^[ê°€-í£]+í¸ì˜$/,
      /^[ê°€-í£]+ì„œë¹„ìŠ¤ê°œì„ $/,
      /^[ê°€-í£]+ì‚¬ìš©ì$/,
      /^[ê°€-í£]+ì´ìš©ì$/,
      /^[ê°€-í£]+ê³ ê°$/,
      /^[ê°€-í£]+ì‹œë¯¼$/,
      /^[ê°€-í£]+ì†Œë¹„ì$/,
      /^[ê°€-í£]+ì°¸ì—¬ì$/,
      /^[ê°€-í£]+ê°œë°œ$/,
      /^[ê°€-í£]+ì—°êµ¬$/,
      /^[ê°€-í£]+ìƒì‚°$/,
      /^[ê°€-í£]+êµ¬ì¶•$/,
      /^[ê°€-í£]+ì§„í–‰$/,
      /^[ê°€-í£]+ê°œë°œì‚¬ì—…$/,
      /^[ê°€-í£]+ìš´ì˜$/,
      /^[ê°€-í£]+ê´€ë¦¬$/,
      /^[ê°€-í£]+ì‹¤ì‹œ$/,
      /^[ê°€-í£]+ì§‘í–‰$/,
      /^[ê°€-í£]+ìˆ˜í–‰$/,
      /^[ê°€-í£]+ìš´ì˜ë°©ì•ˆ$/,
      /^[ê°€-í£]+êµ¬ì¶•$/,
      /^[ê°€-í£]+ì„¤ì¹˜$/,
      /^[ê°€-í£]+ê±´ì„¤$/,
      /^[ê°€-í£]+ë§ˆë ¨$/,
      /^[ê°€-í£]+ì¡°ì„±$/,
      /^[ê°€-í£]+ì‹œìŠ¤í…œêµ¬ì¶•$/,
      /^[ê°€-í£]+ì œê³µ$/,
      /^[ê°€-í£]+ì œì‹œ$/,
      /^[ê°€-í£]+ê³µê¸‰$/,
      /^[ê°€-í£]+ë¶€ì—¬$/,
      /^[ê°€-í£]+ì œê³µì„œë¹„ìŠ¤$/,
      /^[ê°€-í£]+í™œìš©$/,
      /^[ê°€-í£]+ì´ìš©$/,
      /^[ê°€-í£]+ì‘ìš©$/,
      /^[ê°€-í£]+ì ìš©$/,
      /^[ê°€-í£]+í™œìš©ë°©ì•ˆ$/,
      /^[ê°€-í£]+ê°œì‹œ$/,
      /^[ê°€-í£]+ì‹œì‘$/,
      /^[ê°€-í£]+ì°©ìˆ˜$/,
      /^[ê°€-í£]+ê°œí†µ$/,
      /^[ê°€-í£]+ê°œì¥$/,
      /^[ê°€-í£]+ê°œì‹œì¼$/,
      /^[ê°€-í£]+ì¢…ë£Œ$/,
      /^[ê°€-í£]+ë§ˆê°$/,
      /^[ê°€-í£]+ì™„ë£Œ$/,
      /^[ê°€-í£]+íì‡„$/,
      /^[ê°€-í£]+ì¢…ë£Œì¼$/,
      /^[ê°€-í£]+í™•ëŒ€$/,
      /^[ê°€-í£]+ì¦ê°€$/,
      /^[ê°€-í£]+í™•ì¥$/,
      /^[ê°€-í£]+ì¦ëŒ€$/,
      /^[ê°€-í£]+í™•ëŒ€ë°©ì•ˆ$/,
      /^[ê°€-í£]+ì¶•ì†Œ$/,
      /^[ê°€-í£]+ê°ì†Œ$/,
      /^[ê°€-í£]+ì¶•ì†Œ$/,
      /^[ê°€-í£]+ê°ì¶•$/,
      /^[ê°€-í£]+ì¶•ì†Œë°©ì•ˆ$/,
      /^[ê°€-í£]+ê°•í™”$/,
      /^[ê°€-í£]+ì¦ì§„$/,
      /^[ê°€-í£]+ì¦ëŒ€$/,
      /^[ê°€-í£]+í™•ëŒ€$/,
      /^[ê°€-í£]+ê°•í™”ë°©ì•ˆ$/,
      /^[ê°€-í£]+ì™„í™”$/,
      /^[ê°€-í£]+ê²½ê°$/,
      /^[ê°€-í£]+ì¶•ì†Œ$/,
      /^[ê°€-í£]+ê°ì†Œ$/,
      /^[ê°€-í£]+ì™„í™”ë°©ì•ˆ$/,
      /^[ê°€-í£]+ì¡°ì •$/,
      /^[ê°€-í£]+ì¡°ì ˆ$/,
      /^[ê°€-í£]+ë³€ê²½$/,
      /^[ê°€-í£]+ìˆ˜ì •$/,
      /^[ê°€-í£]+ì¡°ì •ë°©ì•ˆ$/,
      /^[ê°€-í£]+ê°œí¸$/,
      /^[ê°€-í£]+ì¬í¸$/,
      /^[ê°€-í£]+ê°œì •$/,
      /^[ê°€-í£]+ê°œì„ $/,
      /^[ê°€-í£]+ê°œí¸ì•ˆ$/,
      /^[ê°€-í£]+ì¬ì •$/,
      /^[ê°€-í£]+ì¬ì •ë¹„$/,
      /^[ê°€-í£]+ì¬êµ¬ì„±$/,
      /^[ê°€-í£]+ì¬ì„¤ì •$/,
      /^[ê°€-í£]+ì¬ì •ë¦½$/,
      /^[ê°€-í£]+ìˆ˜ë¦½$/,
      /^[ê°€-í£]+ì„¤ì •$/,
      /^[ê°€-í£]+ê³„íš$/,
      /^[ê°€-í£]+ë§ˆë ¨$/,
      /^[ê°€-í£]+ìˆ˜ë¦½ë°©ì•ˆ$/,
      /^[ê°€-í£]+ì‹œí–‰$/,
      /^[ê°€-í£]+ì‹¤ì‹œ$/,
      /^[ê°€-í£]+ì ìš©$/,
      /^[ê°€-í£]+ì§‘í–‰$/,
      /^[ê°€-í£]+ìš´ì˜$/,
      /^[ê°€-í£]+ë°œíš¨$/,
      /^[ê°€-í£]+ì‹œí–‰ì¼$/,
      /^[ê°€-í£]+ì‹œí–‰ê³„íš$/,
      /^[ê°€-í£]+í‰ê°€$/,
      /^[ê°€-í£]+ì‹¬ì‚¬$/,
      /^[ê°€-í£]+ë¶„ì„$/,
      /^[ê°€-í£]+ì¸¡ì •$/,
      /^[ê°€-í£]+íŒë‹¨$/,
      /^[ê°€-í£]+í‰ê°€ê¸°ì¤€$/,
      /^[ê°€-í£]+ë¶„ì„$/,
      /^[ê°€-í£]+í•´ì„$/,
      /^[ê°€-í£]+ê²€í† $/,
      /^[ê°€-í£]+ì¡°ì‚¬$/,
      /^[ê°€-í£]+íŒŒì•…$/,
      /^[ê°€-í£]+ë°ì´í„°ë¶„ì„$/,
      /^[ê°€-í£]+ì˜ˆì¸¡$/,
      /^[ê°€-í£]+ì „ë§$/,
      /^[ê°€-í£]+ì¶”ì •$/,
      /^[ê°€-í£]+ì˜ˆìƒ$/,
      /^[ê°€-í£]+ì˜ˆì¸¡ëª¨ë¸$/,
      /^[ê°€-í£]+ëŒ€ì‘$/,
      /^[ê°€-í£]+ëŒ€ì²˜$/,
      /^[ê°€-í£]+ì²˜ë¦¬$/,
      /^[ê°€-í£]+ì¡°ì¹˜$/,
      /^[ê°€-í£]+ë°˜ì‘$/,
      /^[ê°€-í£]+ìœ„ê¸°ëŒ€ì‘$/,
      /^[ê°€-í£]+ì¤€ë¹„$/,
      /^[ê°€-í£]+ëŒ€ë¹„$/,
      /^[ê°€-í£]+ê³„íš$/,
      /^[ê°€-í£]+ë§ˆë ¨$/,
      /^[ê°€-í£]+ì¤€ë¹„ì‚¬í•­$/,
      /^[ê°€-í£]+ì‹¤ì²œ$/,
      /^[ê°€-í£]+í–‰ë™$/,
      /^[ê°€-í£]+ì´í–‰$/,
      /^[ê°€-í£]+ìˆ˜í–‰$/,
      /^[ê°€-í£]+ì‹¤ì²œë°©ì•ˆ$/,
      /^[ê°€-í£]+í˜‘ì˜$/,
      /^[ê°€-í£]+ë…¼ì˜$/,
      /^[ê°€-í£]+ìƒì˜$/,
      /^[ê°€-í£]+ì¡°ì •$/,
      /^[ê°€-í£]+í˜‘ì˜ì‚¬í•­$/,
      /^[ê°€-í£]+ê³µìœ $/,
      /^[ê°€-í£]+ë‚˜ëˆ”$/,
      /^[ê°€-í£]+ë°°í¬$/,
      /^[ê°€-í£]+ì „ë‹¬$/,
      /^[ê°€-í£]+ì •ë³´ê³µìœ $/,
      /^[ê°€-í£]+í™•ì¸$/,
      /^[ê°€-í£]+ê²€ì¦$/,
      /^[ê°€-í£]+ì ê²€$/,
      /^[ê°€-í£]+ì²´í¬$/,
      /^[ê°€-í£]+í™•ì¸ì‚¬í•­$/,
      /^[ê°€-í£]+ê²€í† $/,
      /^[ê°€-í£]+ì‹¬ì‚¬$/,
      /^[ê°€-í£]+ë¶„ì„$/,
      /^[ê°€-í£]+ê³ ë ¤$/,
      /^[ê°€-í£]+ì¬ê²€í† $/,
      /^[ê°€-í£]+ì œì•ˆ$/,
      /^[ê°€-í£]+ê±´ì˜$/,
      /^[ê°€-í£]+ì œì˜$/,
      /^[ê°€-í£]+ë°œì˜$/,
      /^[ê°€-í£]+ì œì•ˆì‚¬í•­$/,
      /^[ê°€-í£]+ì˜ê²¬$/,
      /^[ê°€-í£]+ê²¬í•´$/,
      /^[ê°€-í£]+ìƒê°$/,
      /^[ê°€-í£]+ì£¼ì¥$/,
      /^[ê°€-í£]+ì˜ê²¬ìˆ˜ë ´$/,
      /^[ê°€-í£]+ë…¼ì˜$/,
      /^[ê°€-í£]+í† ë¡ $/,
      /^[ê°€-í£]+í˜‘ì˜$/,
      /^[ê°€-í£]+ìƒì˜$/,
      /^[ê°€-í£]+ë…¼ì˜ì‚¬í•­$/,
      /^[ê°€-í£]+ê²°ì •$/,
      /^[ê°€-í£]+ì„ íƒ$/,
      /^[ê°€-í£]+íŒë‹¨$/,
      /^[ê°€-í£]+í™•ì •$/,
      /^[ê°€-í£]+ê²°ì •ì‚¬í•­$/,
      /^[ê°€-í£]+ë°œí‘œ$/,
      /^[ê°€-í£]+ê³µê°œ$/,
      /^[ê°€-í£]+ê²Œì‹œ$/,
      /^[ê°€-í£]+ë³´ê³ $/,
      /^[ê°€-í£]+ë°œí‘œìë£Œ$/,
      /^[ê°€-í£]+ë³´ê³ $/,
      /^[ê°€-í£]+ì œì¶œ$/,
      /^[ê°€-í£]+ë³´ê³ ì„œ$/,
      /^[ê°€-í£]+ê²°ê³¼ë³´ê³ $/,
      /^[ê°€-í£]+ì¤‘ê°„ë³´ê³ $/,
      /^[ê°€-í£]+ìµœì¢…ë³´ê³ $/,
      /^[ê°€-í£]+ìŠ¹ì¸$/,
      /^[ê°€-í£]+í—ˆê°€$/,
      /^[ê°€-í£]+ì¸ê°€$/,
      /^[ê°€-í£]+ë™ì˜$/,
      /^[ê°€-í£]+ê²°ì¬$/,
      /^[ê°€-í£]+ìŠ¹ì¸ì ˆì°¨$/,
      /^[ê°€-í£]+ë°˜ë ¤$/,
      /^[ê°€-í£]+ê±°ë¶€$/,
      /^[ê°€-í£]+ê¸°ê°$/,
      /^[ê°€-í£]+ë¶€ê²°$/,
      /^[ê°€-í£]+ë°˜ë ¤ì‚¬ìœ $/,
      /^[ê°€-í£]+ì ‘ìˆ˜$/,
      /^[ê°€-í£]+ìˆ˜ë ¹$/,
      /^[ê°€-í£]+ì‹ ì²­$/,
      /^[ê°€-í£]+ë“±ë¡$/,
      /^[ê°€-í£]+ì ‘ìˆ˜ì²˜$/,
      /^[ê°€-í£]+ë°œê¸‰$/,
      /^[ê°€-í£]+êµë¶€$/,
      /^[ê°€-í£]+ìˆ˜ì—¬$/,
      /^[ê°€-í£]+ì œê³µ$/,
      /^[ê°€-í£]+ë°œê¸‰ê¸°ê´€$/,
      /^[ê°€-í£]+ê°±ì‹ $/,
      /^[ê°€-í£]+ì—°ì¥$/,
      /^[ê°€-í£]+ì¬ë“±ë¡$/,
      /^[ê°€-í£]+ì¬ë°œê¸‰$/,
      /^[ê°€-í£]+ê°±ì‹ ê¸°ê°„$/,
      /^[ê°€-í£]+ë“±ë¡$/,
      /^[ê°€-í£]+ê¸°ë¡$/,
      /^[ê°€-í£]+ë“±ì¬$/,
      /^[ê°€-í£]+ì‹ ì²­$/,
      /^[ê°€-í£]+ë“±ë¡ì ˆì°¨$/,
      /^[ê°€-í£]+í•´ì§€$/,
      /^[ê°€-í£]+í•´ì œ$/,
      /^[ê°€-í£]+ì·¨ì†Œ$/,
      /^[ê°€-í£]+ì¢…ë£Œ$/,
      /^[ê°€-í£]+í•´ì§€ì‚¬ìœ $/,
      /^[ê°€-í£]+ì •ì§€$/,
      /^[ê°€-í£]+ì¤‘ë‹¨$/,
      /^[ê°€-í£]+ì¼ì‹œì •ì§€$/,
      /^[ê°€-í£]+ì˜ì—…ì •ì§€$/,
      /^[ê°€-í£]+ì •ì§€ê¸°ê°„$/,
      /^[ê°€-í£]+íì‡„$/,
      /^[ê°€-í£]+íì§€$/,
      /^[ê°€-í£]+ì² ê±°$/,
      /^[ê°€-í£]+ë´‰ì‡„$/,
      /^[ê°€-í£]+íì‡„ëª…ë ¹$/,
      /^[ê°€-í£]+ì´ì „$/,
      /^[ê°€-í£]+ì´ë™$/,
      /^[ê°€-í£]+ì´ê´€$/,
      /^[ê°€-í£]+ì´ì„¤$/,
      /^[ê°€-í£]+ì´ì „ì ˆì°¨$/,
      /^[ê°€-í£]+ì„¤ì¹˜$/,
      /^[ê°€-í£]+êµ¬ì¶•$/,
      /^[ê°€-í£]+ì¥ì°©$/,
      /^[ê°€-í£]+ì„¤ë¹„$/,
      /^[ê°€-í£]+ì„¤ì¹˜ê¸°ì¤€$/,
      /^[ê°€-í£]+ì œê±°$/,
      /^[ê°€-í£]+ì² ê±°$/,
      /^[ê°€-í£]+ì‚­ì œ$/,
      /^[ê°€-í£]+íê¸°$/,
      /^[ê°€-í£]+ì œê±°ë°©ë²•$/,
      /^[ê°€-í£]+ë³´ìˆ˜$/,
      /^[ê°€-í£]+ìˆ˜ë¦¬$/,
      /^[ê°€-í£]+ìœ ì§€$/,
      /^[ê°€-í£]+ì ê²€$/,
      /^[ê°€-í£]+ë³´ìˆ˜ì‘ì—…$/,
      /^[ê°€-í£]+êµì²´$/,
      /^[ê°€-í£]+ëŒ€ì²´$/,
      /^[ê°€-í£]+ë³€ê²½$/,
      /^[ê°€-í£]+êµí™˜$/,
      /^[ê°€-í£]+êµì²´ì‹œê¸°$/,
      /^[ê°€-í£]+í™•ë³´$/,
      /^[ê°€-í£]+í™•ì¶©$/,
      /^[ê°€-í£]+í™•ë³´ë°©ì•ˆ$/,
      /^[ê°€-í£]+í™•ë³´ê³„íš$/,
      /^[ê°€-í£]+ë¶€ì¡±$/,
      /^[ê°€-í£]+ê²°í•$/,
      /^[ê°€-í£]+ë¯¸ë‹¬$/,
      /^[ê°€-í£]+ë¶ˆì¶©ë¶„$/,
      /^[ê°€-í£]+ë¶€ì¡±ë¬¸ì œ$/,
      /^[ê°€-í£]+ì´ˆê³¼$/,
      /^[ê°€-í£]+ê³¼ë‹¤$/,
      /^[ê°€-í£]+ìƒíšŒ$/,
      /^[ê°€-í£]+ëŠ¥ê°€$/,
      /^[ê°€-í£]+ì´ˆê³¼ë¶„$/,
      /^[ê°€-í£]+ì¦ê°€$/,
      /^[ê°€-í£]+ì¦ëŒ€$/,
      /^[ê°€-í£]+í™•ëŒ€$/,
      /^[ê°€-í£]+í–¥ìƒ$/,
      /^[ê°€-í£]+ì¦ê°€ìœ¨$/,
      /^[ê°€-í£]+ê°ì†Œ$/,
      /^[ê°€-í£]+ì¶•ì†Œ$/,
      /^[ê°€-í£]+í•˜ë½$/,
      /^[ê°€-í£]+ì €í•˜$/,
      /^[ê°€-í£]+ê°ì†Œìœ¨$/,
      /^[ê°€-í£]+ìœ ì§€$/,
      /^[ê°€-í£]+ë³´ì¡´$/,
      /^[ê°€-í£]+ì§€ì†$/,
      /^[ê°€-í£]+ì¡´ì†$/,
      /^[ê°€-í£]+ìœ ì§€ê´€ë¦¬$/
    ];
    
    return compoundPatterns.some(pattern => pattern.test(word));
  }
}

class ComprehensiveSynonymDictionaryBuilder {
  constructor() {
    this.extractor = new AdvancedKeywordExtractor();
    this.allKeywords = new Set();
    this.synonymMappings = new Map();
  }

  /**
   * ëª¨ë“  PDFì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (Firestoreì—ì„œ ì²­í¬ ê°€ì ¸ì˜¤ê¸°)
   */
  async extractKeywordsFromAllPDFs() {
    console.log('ğŸ“š Firestoreì—ì„œ PDF ì²­í¬ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
    
    try {
      // Firestoreì—ì„œ ëª¨ë“  ì²­í¬ ê°€ì ¸ì˜¤ê¸°
      const chunksQuery = query(collection(db, 'pdf_chunks'));
      const chunksSnapshot = await getDocs(chunksQuery);
      
      const allText = [];
      let processedDocuments = new Set();
      
      console.log(`ğŸ“¦ ì´ ${chunksSnapshot.size}ê°œ ì²­í¬ ë°œê²¬`);
      
      chunksSnapshot.forEach((doc) => {
        const chunkData = doc.data();
        
        // ë¬¸ì„œë³„ë¡œ ì²« ë²ˆì§¸ ì²­í¬ë§Œ ê¸°ë¡
        if (!processedDocuments.has(chunkData.filename)) {
          processedDocuments.add(chunkData.filename);
          console.log(`ğŸ“„ ë¬¸ì„œ ë°œê²¬: ${chunkData.filename}`);
        }
        
        // ì²­í¬ í…ìŠ¤íŠ¸ ìˆ˜ì§‘
        if (chunkData.content) {
          allText.push(chunkData.content);
        }
      });
      
      // ëª¨ë“  í…ìŠ¤íŠ¸ ê²°í•©
      const fullText = allText.join('\n');
      console.log(`ğŸ“ ì „ì²´ í…ìŠ¤íŠ¸ ê¸¸ì´: ${fullText.length}ì`);
      
      // í‚¤ì›Œë“œ ì¶”ì¶œ
      const keywords = await this.extractor.extractMeaningfulKeywords(fullText);
      keywords.forEach(keyword => this.allKeywords.add(keyword));
      
      console.log(`âœ… ì´ ${this.allKeywords.size}ê°œ ê³ ìœ  í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ`);
      
    } catch (error) {
      console.error('âŒ Firestoreì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
      
      // í´ë°±: ë¡œì»¬ PDF íŒŒì¼ì—ì„œ ì¶”ì¶œ ì‹œë„
      console.log('ğŸ”„ ë¡œì»¬ PDF íŒŒì¼ì—ì„œ ì¶”ì¶œ ì‹œë„...');
      await this.extractFromLocalPDFs();
    }
  }

  /**
   * ë¡œì»¬ PDF íŒŒì¼ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (í´ë°±)
   */
  async extractFromLocalPDFs() {
    try {
      // ë¨¼ì € pdf í´ë” ì‹œë„, ì—†ìœ¼ë©´ public/pdf ì‹œë„
      let pdfDir = path.join(__dirname, '../pdf');
      if (!fs.existsSync(pdfDir) || fs.readdirSync(pdfDir).filter(file => file.endsWith('.pdf')).length === 0) {
        pdfDir = path.join(__dirname, '../public/pdf');
      }
      
      const pdfFiles = fs.readdirSync(pdfDir).filter(file => file.endsWith('.pdf'));
      
      console.log(`ğŸ“š ë¡œì»¬ ${pdfFiles.length}ê°œ PDF íŒŒì¼ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œì‘...`);
      
      for (const pdfFile of pdfFiles) {
        try {
          console.log(`ğŸ” ì²˜ë¦¬ ì¤‘: ${pdfFile}`);
          const pdfPath = path.join(pdfDir, pdfFile);
          const pdfText = await this.extractTextFromPDF(pdfPath);
          
          const keywords = await this.extractor.extractMeaningfulKeywords(pdfText);
          keywords.forEach(keyword => this.allKeywords.add(keyword));
          
          console.log(`âœ… ${pdfFile}: ${keywords.length}ê°œ í‚¤ì›Œë“œ ì¶”ì¶œ`);
        } catch (error) {
          console.error(`âŒ ${pdfFile} ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
        }
      }
      
      console.log(`ğŸ¯ ì´ ${this.allKeywords.size}ê°œ ê³ ìœ  í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ`);
    } catch (error) {
      console.error('âŒ ë¡œì»¬ PDF ì²˜ë¦¬ ì‹¤íŒ¨:', error);
    }
  }

  /**
   * ë™ì˜ì–´/ìœ ì‚¬ì–´ ìƒì„±
   */
  async generateSynonyms() {
    const keywords = Array.from(this.allKeywords);
    console.log(`ğŸ”„ ${keywords.length}ê°œ í‚¤ì›Œë“œì˜ ë™ì˜ì–´ ìƒì„± ì‹œì‘...`);
    
    // ë°°ì¹˜ ì²˜ë¦¬ (API ì œí•œ ê³ ë ¤)
    const batchSize = 10;
    for (let i = 0; i < keywords.length; i += batchSize) {
      const batch = keywords.slice(i, i + batchSize);
      
      console.log(`ğŸ“¦ ë°°ì¹˜ ${Math.floor(i/batchSize) + 1}/${Math.ceil(keywords.length/batchSize)} ì²˜ë¦¬ ì¤‘...`);
      
      const batchPromises = batch.map(async (keyword) => {
        try {
          const synonyms = await this.extractor.generateSynonymsWithAI(keyword);
          this.synonymMappings.set(keyword, synonyms);
          return { keyword, synonyms };
        } catch (error) {
          console.error(`âŒ ${keyword} ë™ì˜ì–´ ìƒì„± ì‹¤íŒ¨:`, error);
          return { keyword, synonyms: [] };
        }
      });
      
      await Promise.all(batchPromises);
      
      // API ì œí•œ ê³ ë ¤í•œ ëŒ€ê¸°
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    console.log(`âœ… ${this.synonymMappings.size}ê°œ í‚¤ì›Œë“œì˜ ë™ì˜ì–´ ìƒì„± ì™„ë£Œ`);
  }

  /**
   * ë™ì˜ì–´ ì‚¬ì „ ì €ì¥
   */
  async saveSynonymDictionary() {
    const dictionary = {
      metadata: {
        totalKeywords: this.allKeywords.size,
        totalSynonyms: Array.from(this.synonymMappings.values()).reduce((sum, synonyms) => sum + synonyms.length, 0),
        createdAt: new Date().toISOString(),
        version: '1.0'
      },
      keywords: Array.from(this.allKeywords),
      synonymMappings: Object.fromEntries(this.synonymMappings)
    };
    
    // data ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
    const dataDir = path.join(__dirname, '../data');
    if (!fs.existsSync(dataDir)) {
      fs.mkdirSync(dataDir, { recursive: true });
    }
    
    const outputPath = path.join(dataDir, 'comprehensive-synonym-dictionary.json');
    fs.writeFileSync(outputPath, JSON.stringify(dictionary, null, 2), 'utf8');
    
    console.log(`ğŸ’¾ ë™ì˜ì–´ ì‚¬ì „ ì €ì¥ ì™„ë£Œ: ${outputPath}`);
    console.log(`ğŸ“Š í†µê³„:`);
    console.log(`   - ì´ í‚¤ì›Œë“œ: ${dictionary.metadata.totalKeywords}ê°œ`);
    console.log(`   - ì´ ë™ì˜ì–´: ${dictionary.metadata.totalSynonyms}ê°œ`);
    console.log(`   - í‰ê·  ë™ì˜ì–´/í‚¤ì›Œë“œ: ${(dictionary.metadata.totalSynonyms / dictionary.metadata.totalKeywords).toFixed(2)}ê°œ`);
  }

  /**
   * PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
   */
  async extractTextFromPDF(pdfPath) {
    const dataBuffer = fs.readFileSync(pdfPath);
    const data = await pdfParse(dataBuffer);
    return data.text;
  }

  /**
   * ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
   */
  async build() {
    try {
      console.log('ğŸš€ í¬ê´„ì  ë™ì˜ì–´ ì‚¬ì „ êµ¬ì¶• ì‹œì‘...');
      
      // 1. ëª¨ë“  PDFì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
      await this.extractKeywordsFromAllPDFs();
      
      // 2. ë™ì˜ì–´/ìœ ì‚¬ì–´ ìƒì„±
      await this.generateSynonyms();
      
      // 3. ë™ì˜ì–´ ì‚¬ì „ ì €ì¥
      await this.saveSynonymDictionary();
      
      console.log('ğŸ‰ í¬ê´„ì  ë™ì˜ì–´ ì‚¬ì „ êµ¬ì¶• ì™„ë£Œ!');
    } catch (error) {
      console.error('âŒ ë™ì˜ì–´ ì‚¬ì „ êµ¬ì¶• ì‹¤íŒ¨:', error);
      throw error;
    }
  }
}

// ì‹¤í–‰
const builder = new ComprehensiveSynonymDictionaryBuilder();
builder.build().catch(console.error);

export default ComprehensiveSynonymDictionaryBuilder;